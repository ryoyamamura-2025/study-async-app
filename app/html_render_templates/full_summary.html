<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>{{title}}</title>
  <style>
    /* =========
       ページサイズ A4 固定
    ========= */
    @page {
      size: A4 portrait;
      margin: 0;
    }

    @font-face {
      font-family: 'IPAexGothic';
      src: url('file:///app/fonts/ipaexg.ttf');
      font-weight: normal;
      font-style: normal;
    }
    
    *, *::before, *::after {
      box-sizing: border-box;
    }

    html {
      margin: 0;
      padding: 0;
      font-family: 'IPAexGothic', sans-serif;
      line-height: 1.5;
      font-size: 10pt;
    }

    /* ★デフォルト（印刷時）のスタイルを定義 */
    body {
      margin: 0;
      padding: 0;
      background: var(--bg); /* 印刷時の背景（ブラウザ設定による） */
      color: var(--fg);
    }

    /* =========
       カラーテーマ（6パターン）
    ========= */
    :root {
      --bg: #FFFFFF; 
      --bg-sin: #e5def7; 
      --fg: #1F1147; 
      --muted: #5E4B8B; 
      --border: #D9CCFF; 
      --accent: #6B3FE3; 
      
      /* 1ページ目のグリッド用 */
      --column: 2;
      --row: 3;
      
      --gap: 8pt;
      --radius: 6pt;
    }

    body[data-theme="mono"] { --bg: #FFFFFF; --bg-sin:#d5daeb; --fg: #1F2023; --muted: #6B6E76; --border: #D0D3D9; --accent: #2F3543; }
    body[data-theme="red"] { --bg: #FFFFFF; --bg-sin: #f7dbd9; --fg: #3B0A07; --muted: #8A5A55; --border: #F4C9C2; --accent: #E23B2A; }
    body[data-theme="blue"] { --bg: #FFFFFF; --bg-sin: #d6e5fd; --fg: #0F2447; --muted: #576A92; --border: #C8D9FF; --accent: #2A6AF0; }
    body[data-theme="green"] { --bg: #FFFFFF; --bg-sin: #c3f5df; --fg: #0E3A24; --muted: #4D6D5F; --border: #C8EFD7; --accent: #1FA766; }
    body[data-theme="purple"] { --bg: #FFFFFF; --bg-sin: #e5def7; --fg: #1F1147; --muted: #5E4B8B; --border: #D9CCFF; --accent: #6B3FE3; }
    body[data-theme="orange"] { --bg: #FFFFFF; --bg-sin: #fcdfcc; --fg: #3F2310; --muted: #8A6B53; --border: #F6D5B8; --accent: #F5801F; }

    /* =========
       ページ共通のレイアウト
    ========= */
    .page {
      width: 210mm;
      height: 297mm;
      padding: 20mm;
      background: var(--bg);
      color: var(--fg);
      display: flex;
      flex-direction: column;
      overflow: hidden; /* ページサイズを超えるコンテンツは隠す */
    }

    .report-header {
      margin-bottom: 12pt;
      flex-shrink: 0;
    }
    
    .report-title, .report-abstruct { margin: 0;}
    .report-title { font-size: 1.6em; margin-bottom: 0.5em;}
    .report-abstruct {background: var(--bg-sin); padding: 10px; border-left: 4px solid var(--muted);}


    /* ====================================
       1ページ目：セクションサマリーのレイアウト
    ==================================== */
    .sections {
      flex-grow: 1;
      overflow: hidden;
      height: 240mm;
    }
    
    .sections::after {
      content: "";
      display: table;
      clear: both;
    }

    .sections > .report-section {
      float: left;
      width: calc((100% - (var(--column) - 1) * var(--gap)) / var(--column));
      max-width: calc((100% - (var(--column) - 1) * var(--gap)) / var(--column));
      height: calc((100% - (var(--row) - 1) * var(--gap)) / var(--row));
      max-height: calc((100% - (var(--row) - 1) * var(--gap)) / var(--row));
      margin-bottom: var(--gap);
      /* border: 1px solid var(--border); */
      border-radius: var(--radius);
      padding: 8pt;
      background: color-mix(in srgb, var(--bg) 94%, white);
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }
    
    .sections > .report-section:not(:nth-of-type(var(--column)n)) {
      margin-right: var(--gap);
    }

    .sections > .report-section:nth-last-child(-n + var(--column)) {
      margin-bottom: 0;
    }

    .section-title {
      font-size: 1.2em;
      margin: 0 0 6pt;
      padding-bottom: 4pt;
      border-bottom: 2px solid var(--border);
      flex-shrink: 0;
    }

    .section-content {
      display: flex;
      flex-direction: column;
      gap: 6pt;
      flex-grow: 1;
      overflow: hidden;
    }

    .image-placeholder {
      width: 100%;
      height: 60%;
      flex-shrink: 0;
      display: flex;
      justify-content: center;
      align-items: center;
      overflow: hidden;
    }
    
    .screenshot-image {
      max-width: 100%;
      max-height: 100%;
      object-fit: contain;
      border: 1px solid var(--border);
      /* border-radius: 4pt; */
      align-items: center;
    }

    .section-abstruct {
      margin: 0;
      font-size: 0.9em;
      line-height: 1.4;
      overflow-y: auto;
      flex-grow: 1; 
    }

    /* ====================================
       2ページ目以降：詳細シーンのレイアウト
    ==================================== */
    .subsequent-container {
      /* 印刷時にコンテンツが複数ページにまたがれるように、height は指定しない */
      width: 210mm;
      padding: 20mm;
      background: var(--bg);
      color: var(--fg);
    }
    
    .sub-section {
        margin-top: 16pt;
        margin-bottom: 16pt;
    }
    .sub-section:last-child {
      margin-bottom: 0;
    }

    .sub-section-title {
      font-size: 1.4em;
      margin: 0 0 10pt;
      padding-bottom: 6pt;
      border-bottom: 2px solid var(--accent);
    }

    .scene {
      display: grid;
      gap: var(--gap);
      padding: 8pt 0;
      border-bottom: 1px solid var(--border);
    }
    .scene:last-child {
      border-bottom: none;
    }

    /* 画像ありのシーン（3列） */
    .scene.with-image {
      grid-template-columns: 160px 1fr 120px;
    }

    /* 画像なしのシーン（2列） */
    .scene.no-image {
      grid-template-columns: 1fr 120px;
    }

    .image-placeholder-sub {
      width: 100%;
      height: 90px; /* 画像の高さを固定 */
      display: flex;
      justify-content: center;
      align-items: center;
      overflow: hidden;
    }

    .scene-description {
      margin: 0;
      font-size: 0.95em;
    }
    
    .scene-memo-col {
      border: none; /* ← ボーダーなし */
      border-radius: var(--radius);
      background: color-mix(in srgb, var(--bg) 96%, white);
      align-self: stretch; /* 高さを他の列に合わせる */
    }
    
    .scene-memo-col p {
      font-size: 8px;
      margin-top: 0;
      margin-left: 4pt; 
    }

    /* ===================================================
       画面表示用のスタイル調整（複数ページ対応）
    =================================================== */
    @media screen {
      body {
        background-color: #EAEAEA;
        width: auto;
        height: auto;
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 2rem 0;
        gap: 2rem;
      }

      /* ページ共通の見た目（A4用紙風） */
      .page, .subsequent-container {
        box-shadow: 0 5px 20px rgba(0, 0, 0, 0.2);
        margin: 0;
        /* A4サイズより画面が小さい場合でも見切れないようにする */
        max-width: 100%; 
        /* 画面表示時はコンテンツに合わせて高さを可変にする */
        height: auto; 
        min-height: 297mm; /* ただし最低高さは保つ */
      }
      .page {
        min-height: 297mm;
      }
      .subsequent-container {
        min-height: 297mm;
      }

      /* 1ページ目のセクションの最低高さを確保 */
      .sections > .report-section {
          min-height: 200px;
      }
      
      /* スマホなど狭い画面用の調整 */
      @media (max-width: 820px) { /* A4幅(210mm)より少し広いくらいをブレークポイントに */
        body {
          padding: 0;
          gap: 0;
        }
        .page, .subsequent-container {
          width: 100%;
          min-height: 100vh;
          box-shadow: none;
          padding: 1rem;
        }

        /* 1ページ目のセクションを1列に */
        .sections > .report-section,
        .sections > .report-section:not(:nth-of-type(var(--column)n)) {
            float: none;
            width: 100%;
            height: auto;
            margin-right: 0;
        }

        /* 2ページ目以降のシーンレイアウトを縦積みに */
        .scene.with-image, .scene.no-image {
          grid-template-columns: 1fr; /* 1列にする */
        }
        .scene-memo-col {
          min-height: 100px; /* メモ欄の最低高さを確保 */
        }
      }
    }

    /* ===========================
       印刷時のスタイル
    =========================== */
    @media print {
      body {
        background: var(--bg); /* 印刷時はbodyの背景をなくす */
      }
    /*
      画像内の各項目（画像＋テキスト）のコンテナを想定しています。
      クラス名は実際のHTMLに合わせて変更してください。
    */
    .report-item { /* 例: .section, .content-block など */
        /* 要素の途中でページが区切られるのを防ぎ、見栄えを良くします */
        break-inside: avoid;
        page-break-inside: avoid; /* 古いブラウザ用の互換設定 */

        /* margin-topの代わりにpadding-topで内側に余白を作り、
        ページ先頭でもスペースが消えないようにします。*/
        padding-top: 24px; /* 元のmargin-topと同じくらいの値に調整してください */
    }
      /* 1ページ目の後で必ず改ページ */
      .page {
        break-after: page;
        height: 297mm; /* 印刷時は高さを固定 */
      }
      /* 最後の要素の後には改ページしない（余分な白紙を防ぐ） */
      .page:last-child, .subsequent-container:last-child {
        break-after: auto;
      }

      .subsequent-container {
        height: auto; /* コンテンツ量に合わせる */
        padding-top: 0mm; /* 印刷時の天マージン */
      }

      .sub-section {
        padding-top: 10mm;
      }

    /* .sub-section:first-child {
        padding-top: 0;
    }       */

      /* 要素の途中で改ページされるのを防ぐ */
      .report-section, .sub-section, .scene {
        break-inside: avoid;
      }

      /* 印刷時はスクロールバーを非表示に */
      .section-abstruct {
        overflow-y: visible;
      }
    }
  </style>
</head>

<!-- テーマ指定: "mono", "red", "blue", "green", "purple", "orange" -->
<body data-theme="purple">

  <!-- =======================================================
       1ページ目：サマリーページ
       ======================================================= -->
  <article class="report page">
    <header class="report-header">
      <h1 class="report-title">{{title}}</h1>
      <p class="report-abstruct">{{abstruct}}</p>
    </header>
    <!-- 1ページ目用のセクショングリッドがここに挿入される -->
    <div class="sections">
      {{sections}}
    </div>
  </article>

  <!-- =======================================================
       2ページ目以降：詳細コンテンツ
       Python側でこのプレースホルダーにHTMLを挿入する。
       コンテンツがない場合は、このプレースホルダーを空文字列に置換する。
       ======================================================= -->
  {{subsequent_content}}

</body>
</html>